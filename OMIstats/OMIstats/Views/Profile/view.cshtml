@model OMIstats.Models.Persona
@using System.Text.RegularExpressions;

@section AddToHead
{
    <link href="~/Content/profile.css" type="text/css" rel="stylesheet" />
    <link href="~/Content/tablas.css" type="text/css" rel="stylesheet" />
    <link href="~/Content/olimpiadas.css" type="text/css" rel="stylesheet" />
}

@section scripts
{
    <script type="text/javascript" src="/Scripts/jquery.tablesorter.js"></script>
    <script type="text/javascript" src="/Scripts/jquery.metadata.js"></script>
    <script type="text/javascript" src="/js/sortMedallas.js"></script>
    <script>
        $(function () {
            agregaSorter("tablaCompetidor");
        });
        $(function () {
            agregaSorter("tablaAsistente");
        });
    </script>
}

@{
    ViewBag.Title = Model.nombre;
}

    <h1 class="titulo">Datos de usuario</h1>

    <div class="foto" >
        <img src='@Url.Content(@Model.foto)' alt="@Model.nombre"/>
    </div>

    <div class="datosParticipante">

        <div class="nombrePerfil">@Html.DisplayFor(model => model.nombre)</div>
    
        <div>
            <div class="fechaNacimiento">
                @if (Model.nacimiento.Year > 1900)
                {
                    @Model.nacimiento.ToString("dd/MM/yyyy")
                }
            </div>
            <div class="perfilUsuario">
                Usuario: @Html.DisplayFor(model => model.usuario)
            </div>
        </div>

        <div class="contacto">

            @if (Model.ioiID != 0)
            {
                <a href='@Url.Content("http://stats.ioinformatics.org/people/" + @Model.ioiID)' target="_blank"><img src="~/img/ioi.png" alt="ioi" style="width:20px;"/></a>
            }

            @if (Model.sitio.Length > 0)
            {
                <a href="@Model.sitio" target="_blank"><img src="~/img/homepage.png" alt="sitio"/></a>
            }

            @if (Model.correo.Length > 0)
            {
                <a href="mailto:@Model.correo" target="_blank"><img src="~/img/mail.png" alt="correo"/></a>
            }

            @if (Model.facebook.Length > 0)
            {
                <a href='@Url.Content("https://www.facebook.com/" + @Model.facebook)' target="_blank"><img src="~/img/facebook.png" alt="facebook"/></a>
            }

            @if (Model.twitter.Length > 0)
            {
                <a href='@Url.Content("http://www.twitter.com/" + @Model.twitter)' target="_blank"><img src="~/img/twitter.png" alt="twitter"/></a>
            }
        </div>

    </div>

    <div class="botones">

        @if ((@ViewBag.usuario == null || @ViewBag.usuario.clave == 0) && Regex.IsMatch(Model.usuario, @"^\d+$"))
        {
            <div>
                @Html.ActionLink("Reclamar usuario", "Claim", "Request",
                                 new { usuario = Model.usuario }, new { @class = "botonPerfil" })
            </div>
            <br />
        }

        @if (@ViewBag.usuario != null)
        {
            if (@ViewBag.usuario.clave != 0 && (@ViewBag.usuario.clave == Model.clave))
            {
                <div>
                    @Html.ActionLink("Actualizar datos", "Edit", "Profile",
                                     null, new { @class = "botonPerfil" })
                </div>
                <br />
            }

            if (@ViewBag.usuario.admin)
            {
                if (@ViewBag.usuario.clave != Model.clave)
                {
                    <div>
                        @Html.ActionLink("Mandar contraseña", "ResetPassword", "Admin",
                                         new { usuario = Model.usuario }, new { @class = "botonPerfil" })
                    </div>
                    <br />

                    <div>
                        @Html.ActionLink("Asignar cuenta", "Claim", "Request",
                                         new { usuario = Model.usuario }, new { @class = "botonPerfil" })
                    </div>
                    <br />

                    <div>
                        <a href='@Url.Content("/Admin/Change?usuario=" + Model.usuario)' class="botonPerfil">
                            @if (Model.admin)
                            {
                                <span>Eliminar Admin</span>
                            }
                            else
                            {
                                <span>Hacer admin</span>
                            }
                        </a>
                    </div>
                    <br />
                }
            }
        }

    </div>

    @if (ViewBag.tienePeticiones)
    {
        <div style="clear:both">
            Tienes peticiones que los administradores aún no han respondido, si quieres verlas, da clic <a href="/Request/view">aquí</a>.
        </div>
    }

    <div style="clear:both">
        @if (ViewBag.usuario != null && ViewBag.usuario.clave == Model.clave && !ViewBag.usuario.admin)
        {
            <!-- -TODO- Enlace -->
            <span>Si tuviste participaciones que no están listadas en nuestra página, mándanos un correo con los datos faltantes.</span>
        }
    </div>

    @if (ViewBag.participaciones.Count > 0)
    {
        <h1 class="titulo subtitulo"> Participaciones como competidor </h1>

        <table class="table tablePadding tablaResultados" id="tablaCompetidor">
            <thead>
                <tr class="table-header">
                    <th></th>
                    <th class="bottom-border right-border table-header-clickable">Olimpiada</th>
                    <th class="bottom-border right-border table-header-clickable">Estado</th>
                    <th class="bottom-border right-border table-header-clickable">Clave</th>
                    <th class="bottom-border right-border table-header-clickable">Puntos</th>
                    <th class="bottom-border right-border table-header-clickable {sorter:'medalla'}">Medalla</th>
                    <th class="bottom-border table-header-clickable">Escuela</th>
                </tr>
            </thead>
            <tbody>
            @for (var l = 0; l < ViewBag.participaciones.Count; l++)
            {
                OMIstats.Models.Resultados datos = ViewBag.participaciones[l];
                OMIstats.Models.Olimpiada omi = OMIstats.Models.Olimpiada.obtenerOlimpiadaConClave(datos.omi, datos.tipoOlimpiada);
                string claseCSS = "";
                switch (datos.medalla)
                {
                    case OMIstats.Models.Resultados.TipoMedalla.BRONCE:
                        {
                            claseCSS = "table-td-bronce";
                            break;
                        }
                    case OMIstats.Models.Resultados.TipoMedalla.PLATA:
                        {
                            claseCSS = "table-td-plata";
                            break;
                        }
                    case OMIstats.Models.Resultados.TipoMedalla.ORO:
                    case OMIstats.Models.Resultados.TipoMedalla.ORO_1:
                    case OMIstats.Models.Resultados.TipoMedalla.ORO_2:
                    case OMIstats.Models.Resultados.TipoMedalla.ORO_3:
                        {
                            claseCSS = "table-td-oro";
                            break;
                        }
                }
                bool mostrar = ViewBag.admin || omi.datosPublicos || datos.publico ||
                    (datos.medalla != OMIstats.Models.Resultados.TipoMedalla.NADA &&
                        datos.medalla != OMIstats.Models.Resultados.TipoMedalla.NULL) ||
                        datos.usuario == ViewBag.claveUsuario;
                <tr>
                    <td class="ioi-mini-imagen">
                        @if(datos.ioi == "A" || datos.ioi == "B")
                        {
                            <img src="/img/ioi.png" />
                            <!-- -TODO- Agregar enlace a IOI -->
                        }
                    </td>
                    <td class="@("table-td right-border " + claseCSS)">
                        <a class="nombre" href="@Url.Content("/Olimpiada/Resultados?clave=" + datos.omi)">
                            @(datos.omi + "ª OMI")
                        </a>
                    </td>
                    <td class="@("table-td right-border " + claseCSS)">
                        <a class="nombre" href="@Url.Content("/Estado?clave=" + datos.estado)">
                            @datos.nombreEstado
                        </a>
                    </td>
                    <td class="@("table-td center right-border " + claseCSS)">
                        @if (!datos.clave.StartsWith(OMIstats.Models.Resultados.CLAVE_FALTANTE))
                        {
                            <span>
                                @datos.clave
                            </span>
                        }
                    </td>
                    <td class="@("table-td center right-border resultado-total " + claseCSS)">
                        @if (mostrar)
                        {
                            @(datos.total)
                        }
                    </td>
                    <td class="@("table-td center right-border " + claseCSS)" medalla="@((int)datos.medalla)">
                        @switch (datos.medalla)
                        {
                            case OMIstats.Models.Resultados.TipoMedalla.ORO_1:
                                {
                                    <span>ORO (I)</span>
                                    break;
                                }
                            case OMIstats.Models.Resultados.TipoMedalla.ORO_2:
                                {
                                    <span>ORO (II)</span>
                                    break;
                                }
                            case OMIstats.Models.Resultados.TipoMedalla.ORO_3:
                                {
                                    <span>ORO (III)</span>
                                    break;
                                }
                            case OMIstats.Models.Resultados.TipoMedalla.ORO:
                            case OMIstats.Models.Resultados.TipoMedalla.PLATA:
                            case OMIstats.Models.Resultados.TipoMedalla.BRONCE:
                                {
                                    <span>@datos.medalla.ToString()</span>
                                    break;
                                }
                        }
                    </td>
                    <td class="@("table-td break-word escuela-td " + claseCSS)">
                        @if (datos.escuela != null)
                        {
                            <span>
                                <a class="nombre" href="@Url.Content("/Escuela?url=" + datos.escuela.nombreURL)">
                                    @datos.escuela.nombreCorto
                                </a>
                            </span>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }

    @if (ViewBag.asistencias.Count > 0)
    {
        if (ViewBag.participaciones.Count > 0)
        {
            <h1 class="titulo subtitulo"> Participaciones con diferente rol </h1>
        }
        else
        {
            <h1 class="titulo subtitulo"> Participaciones en olimpiadas</h1>
        }

        <table class="table tablePadding tablaResultados" id="tablaAsistente">
            <thead>
                <tr class="table-header">
                    <th></th>
                    <th class="bottom-border right-border table-header-clickable">Olimpiada</th>
                    <th class="bottom-border right-border table-header-clickable">Estado</th>
                    <th class="bottom-border table-header-clickable">Rol</th>
                </tr>
            </thead>
            <tbody>
            @for (var l = 0; l < ViewBag.asistencias.Count; l++)
            {
                OMIstats.Models.MiembroDelegacion datos = ViewBag.asistencias[l];
                <tr>
                    <td class="ioi-mini-imagen">
                    </td>
                    <td class="table-td right-border">
                        <a class="nombre" href="@Url.Content("/Olimpiada?clave=" + datos.olimpiada)">
                            @(datos.olimpiada + "ª OMI")
                        </a>
                    </td>
                    <td class="table-td right-border">
                        <a class="nombre" href="@Url.Content("/Estado?clave=" + datos.estado)">
                            @datos.nombreEstado
                        </a>
                    </td>
                    <td class="table-td center">
                        @if (datos.tipo == OMIstats.Models.MiembroDelegacion.TipoAsistente.DELELIDER)
                        {
                            <span>DELEGADO Y LIDER</span>
                        }
                        else
                        {
                           @(datos.tipo.ToString())
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }