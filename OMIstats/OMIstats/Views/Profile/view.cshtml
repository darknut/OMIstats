@model OMIstats.Models.Persona
@using System.Text.RegularExpressions;

@section AddToHead
{
    <link href="~/Content/profile.css" type="text/css" rel="stylesheet" />
    <link href="~/Content/tablas.css" type="text/css" rel="stylesheet" />
    <link href="~/Content/olimpiadas.css" type="text/css" rel="stylesheet" />
}

@section scripts
{
    <script type="text/javascript" src="/Scripts/jquery.tablesorter.js"></script>
    <script type="text/javascript" src="/Scripts/jquery.metadata.js"></script>
    <script type="text/javascript" src="/js/sorters.js"></script>
    <script>
        $(function () {
            agregaSorterMedallas("tablaCompetidor");
            agregaSorterOMI("tablaCompetidor");
            cargaSorter("tablaCompetidor");
        });
        $(function () {
            agregaSorterMedallas("tablaAsistente");
            agregaSorterOMI("tablaAsistente");
            cargaSorter("tablaAsistente");
        });
    </script>
}

@{
    ViewBag.Title = Model.nombre;
}

    @{
    string GUID = ViewBag.GUID;
    OMIstats.Utilities.TableManager tableManager = new OMIstats.Utilities.TableManager(ViewBag.admin, ViewBag.claveUsuario);
    if (GUID.Length > 0)
    {
        <p class="errorTextoRojo textoGrande">
            Este es el perfil que creemos te pertenece. ¿Es este tu perfil de usuario?
        </p>
        @Html.ActionLink("Sí", "In", "Log", new { GUID = GUID, force = true }, new { @class="botonPerfil" })
        <span>&nbsp;</span>
        @Html.ActionLink("No", "Login", "Request", new { nombre = Model.nombre, correo = Model.correo,
                tipo = OMIstats.Models.Peticion.TipoPeticion.BAD_LINK }, new { @class="botonPerfil", target="_blank" })
        <br />
        <br />
        <br />
    }
    }


    <h1 class="titulo">Datos de usuario</h1>

    <div class="foto" >
        <img src='@Url.Content(@Model.foto)' alt="@Model.nombre"/>
    </div>

    <div class="datosParticipante">

        <div class="nombrePerfil">@Html.DisplayFor(model => model.nombre)</div>
    
        <div>
            <div class="fechaNacimiento">
                @if (Model.nacimiento.Year > 1900)
                {
                    @Model.nacimiento.ToString("dd/MM/yyyy")
                }
            </div>
        </div>

        <div class="contacto">

            @if (Model.ioiID != 0)
            {
                <a href='@tableManager.getIOIStatsLink(Model.ioiID)' target="_blank"><img src="~/img/ioi.png" alt="ioi" style="width:20px;"/></a>
            }

            @if (Model.sitio.Length > 0)
            {
                <a href="@Model.sitio" target="_blank"><img src="~/img/homepage.png" alt="sitio"/></a>
            }

            @if (Model.correo.Length > 0)
            {
                <a href="mailto:@Model.correo" target="_blank"><img src="~/img/mail.png" alt="correo"/></a>
            }

            @if (Model.facebook.Length > 0)
            {
                <a href='@Url.Content("https://www.facebook.com/" + @Model.facebook)' target="_blank"><img src="~/img/facebook.png" alt="facebook"/></a>
            }

            @if (Model.twitter.Length > 0)
            {
                <a href='@Url.Content("http://www.twitter.com/" + @Model.twitter)' target="_blank"><img src="~/img/twitter.png" alt="twitter"/></a>
            }

            @if (Model.omegaup.Length > 0)
            {
                <a href='@Url.Content("https://omegaup.com/profile/" + @Model.omegaup)' target="_blank"><img class="omegaIcon" src="~/img/omega.png" alt="omegaup"/></a>
            }
        </div>

    </div>

    <div class="botones">

        @if (@ViewBag.usuario != null)
        {
            if (ViewBag.usuario.admin || (@ViewBag.usuario.clave != 0 && (@ViewBag.usuario.clave == Model.clave)))
            {
                <div>
                    @Html.ActionLink("Actualizar datos", "Edit", "Profile",
                                ViewBag.usuario.admin ? new { usuario = Model.usuario } : null,
                                new { @class = "botonPerfil" })
                </div>
                <br />
            }

            if (@ViewBag.usuario.admin)
            {
                if (@ViewBag.usuario.clave != Model.clave)
                {
                    <div>
                        <a href='@Url.Content("~/Admin/Change?usuario=" + Model.usuario)' class="botonPerfil">
                            @if (Model.admin)
                            {
                                <span>Eliminar Admin</span>
                            }
                            else
                            {
                                <span>Hacer admin</span>
                            }
                        </a>
                    </div>
                    <br />
                    <div>
                        <a href='@Url.Content("~/Admin/Unlink?usuario=" + Model.usuario)' class="botonPerfil">
                            Deslinkear usuario
                        </a>
                    </div>
                    <br />
                }
            }
        }

    </div>

    @if (ViewBag.tienePeticiones)
    {
        <div style="clear:both" class="errorTextoRojo">
            Tienes peticiones que los administradores aún no han respondido, si quieres verlas, da clic <a href="~/Request/view">aquí</a>.
        </div>
        <br />
    }

    <div style="clear:both">
        @if (ViewBag.usuario != null && ViewBag.usuario.clave == Model.clave && !ViewBag.usuario.admin)
        {
            <div>
                @Html.ActionLink("¿No eres tú?", "user", "Request",
                    new { tipo = OMIstats.Models.Peticion.TipoPeticion.NO_SOY_YO }, null) |
                @Html.ActionLink("¿Perfil incompleto?", "user", "Request",
                    new { tipo = OMIstats.Models.Peticion.TipoPeticion.INCOMPLETO }, null) |
                @Html.ActionLink("¿Perfil duplicado?", "user", "Request",
                    new { tipo = OMIstats.Models.Peticion.TipoPeticion.DUPLICADO }, null)
                <br />
                @Html.ActionLink("¿Te sabes tus puntos y nosotros no?", "user", "Request",
                    new { tipo = OMIstats.Models.Peticion.TipoPeticion.PUNTOS }, null) |
                @Html.ActionLink("Contáctanos", "General", "Request")
            </div>
        }
    </div>

    @{
        OMIstats.Models.TipoOlimpiada tipoOlimpiada = ViewBag.tipo;
        Dictionary<OMIstats.Models.TipoOlimpiada, List<OMIstats.Models.Resultados>> participaciones = ViewBag.participaciones;
        OMIstats.Models.Medalleros medalleros = ViewBag.medalleros;
        bool hayParticipaciones = false;
    }

    @foreach (OMIstats.Models.TipoOlimpiada tipo in Enum.GetValues(typeof(OMIstats.Models.TipoOlimpiada)))
    {
        List<OMIstats.Models.Resultados> participacion = null;
        participaciones.TryGetValue(tipo, out participacion);
        if (participacion == null || participacion.Count == 0)
        {
            continue;
        }
        hayParticipaciones = true;
        OMIstats.Models.Medallero medallero = medalleros.medalleroDeTipo(tipo);

        <h1 class="titulo subtitulo"> Participaciones como competidor
            @if (tipo == OMIstats.Models.TipoOlimpiada.OMIS)
            {
                <span>de secundaria</span>
            }
            @if (tipo == OMIstats.Models.TipoOlimpiada.OMIP)
            {
                <span>de primaria</span>
            }
        </h1>

        <div class="medallero">
            <img src="@Url.Content("~/img/" + tipo.ToString() + ".png")" class="tipoOMI"/>
            <div class="separador">:</div>
            <div class="medalla" title="Medallas de oro">
                <div><img src="~/img/oro.png"/></div>
                <div>@(medallero.oros)</div>
            </div>
            <div class="medalla" title="Medallas de plata">
                <div><img src="~/img/plata.png"/></div>
                <div>@(medallero.platas)</div>
            </div>
            <div class="medalla" title="Medallas de bronce">
                <div><img src="~/img/bronce.png"/></div>
                <div>@(medallero.bronces)</div>
            </div>
            @if (medallero.otros > 0)
            {
                <div class="medalla" title="Participaciones sin medalla">
                    <div><img src="~/img/diploma.png"/></div>
                    <div>@(medallero.otros)</div>
                </div>
            }
        </div>

        <table class="table tablePadding" id="tablaCompetidor">
            <thead>
                <tr class="table-header">
                    <th></th>
                    <th class="bottom-border right-border table-header-clickable">Lugar</th>
                    <th class="bottom-border right-border table-header-clickable {sorter:'omi'}">Olimpiada</th>
                    <th class="bottom-border right-border table-header-clickable">Estado</th>
                    <th class="bottom-border right-border table-header-clickable">Clave</th>
                    <th class="bottom-border right-border table-header-clickable">Puntos</th>
                    <th class="bottom-border right-border table-header-clickable {sorter:'medalla'}">Medalla</th>
                    <th class="bottom-border right-border table-header-clickable">Escuela</th>
                    <th class="bottom-border right-border table-header-clickable">Nivel escolar</th>
                    <th class="bottom-border table-header-clickable">Año escolar</th>
                </tr>
            </thead>
            <tbody>
            @for (var l = 0; l < participacion.Count; l++)
            {
                OMIstats.Models.Resultados datos = participacion[l];
                tableManager.setCurrentResultados(datos);
                tableManager.setCurrentOMI();
                string claseCSS = tableManager.obtenerClaseCSS();
                bool mostrar = tableManager.mostrarLinea();
                <tr>
                    <td class="ioi-mini-imagen">
                        @if (tableManager.mostrarLogoIOI())
                        {
                            <a href="@tableManager.getIOIStatsLinkForPerson()" target="_blank">
                                <img src="~/img/ioi.png" />
                            </a>
                        }
                    </td>
                    <td class="@("table-td right-border center " + claseCSS)">
                        @if (mostrar && datos.lugar > 0)
                        {
                            @(datos.lugar)
                        }
                    </td>
                    <td class="@("table-td right-border " + claseCSS)" omi="@(datos.omi)">
                        <a class="nombre" href="@Url.Content("~/Olimpiada/Resultados?clave=" + datos.omi + "&tipo=" + tipo.ToString())">
                            @tableManager.enlaceOMI()
                        </a>
                    </td>
                    <td class="@("table-td right-border " + claseCSS)">
                        <a class="nombre" href="@Url.Content("~/Estado?clave=" + datos.estado + "&tipo=" + tipo.ToString())">
                            @datos.nombreEstado
                        </a>
                    </td>
                    <td class="@("table-td center right-border " + claseCSS)">
                        @if (!tableManager.faltaClave())
                        {
                            <a class="nombre" href="@Url.Content("~/Olimpiada/Delegacion?clave=" + datos.omi + "&estado=" + datos.estado + "&tipo=" + tipo.ToString())">
                                @datos.clave
                            </a>
                        }
                    </td>
                    <td class="@("table-td center right-border resultado-total " + claseCSS)">
                        @if (mostrar)
                        {
                            @(datos.total)
                        }
                    </td>
                    <td class="@("table-td center right-border " + claseCSS)" medalla="@((int)datos.medalla)">
                        @tableManager.medallaString()
                    </td>
                    <td class="@("table-td break-word right-border " + claseCSS)">
                        @if (datos.escuela != null)
                        {
                            <span>
                                <a class="nombre" href="@Url.Content("~/Escuela?url=" + datos.escuela.nombreURL + "&tipo=" + tipo.ToString())">
                                    @datos.escuela.nombreCorto
                                </a>
                            </span>
                        }
                    </td>
                    <td class="@("table-td right-border " + claseCSS)">
                        @if (datos.nivelInstitucion != OMIstats.Models.Institucion.NivelInstitucion.NULL)
                        {
                            @(datos.nivelInstitucion.ToString())
                        }
                    </td>
                    <td class="@("table-td center " + claseCSS)">
                        @if (datos.añoEscolar != 0)
                        {
                            @(datos.añoEscolar + "º")
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }

    @if (ViewBag.asistencias.Count > 0)
    {
        if (hayParticipaciones)
        {
            <h1 class="titulo subtitulo"> Participaciones con diferente rol </h1>
        }
        else
        {
            <h1 class="titulo subtitulo"> Participaciones en olimpiadas</h1>
        }

        <table class="table tablePadding" id="tablaAsistente">
            <thead>
                <tr class="table-header">
                    <th></th>
                    <th class="bottom-border right-border table-header-clickable {sorter:'omi'}">Olimpiada</th>
                    <th class="bottom-border right-border table-header-clickable">Estado</th>
                    <th class="bottom-border table-header-clickable">Rol</th>
                </tr>
            </thead>
            <tbody>
            @for (var l = 0; l < ViewBag.asistencias.Count; l++)
            {
                OMIstats.Models.MiembroDelegacion datos = ViewBag.asistencias[l];
                tableManager.setCurrentOMI(OMIstats.Models.Olimpiada.obtenerOlimpiadaConClave(datos.olimpiada, tipoOlimpiada));
                <tr>
                    <td class="ioi-mini-imagen">
                    </td>
                    <td class="table-td right-border" omi="@(datos.olimpiada)">
                        <a class="nombre" href="@Url.Content("~/Olimpiada?clave=" + datos.olimpiada + "&tipo=" + tipoOlimpiada.ToString())">
                            @(tableManager.enlaceOMI())
                        </a>
                    </td>
                    <td class="table-td right-border">
                        <a class="nombre" href="@Url.Content("~/Estado?clave=" + datos.estado + "&tipo=" + tipoOlimpiada.ToString())">
                            @datos.nombreEstado
                        </a>
                    </td>
                    <td class="table-td center">
                        <a class="nombre" href="@Url.Content("~/Olimpiada/Delegacion?clave=" + datos.olimpiada + "&estado=" + datos.estado + "&tipo=" + tipoOlimpiada.ToString())">
                            @datos.getTipoAsistenteString()
                        </a>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }